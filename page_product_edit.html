<!DOCTYPE html>
<!--[if IE 8]>
<html lang="en" class="ie8"> <![endif]-->
<!--[if IE 9]>
<html lang="en" class="ie9"> <![endif]-->
<!--[if !IE]><!-->
<html lang="en" xmlns="http://www.w3.org/1999/html"> <!--<![endif]-->
<head>
    <title>Add Product Page - Cagliari Port 2020</title>

    <!-- Meta -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Favicon -->
    <link rel="shortcut icon" href="favicon.ico">

    <!-- Web Fonts
    <link rel='stylesheet' type='text/css' href='http://fonts.googleapis.com/css?family=Open+Sans:400,300,600&amp;subset=cyrillic,latin'>-->

    <!-- CSS Global Compulsory -->
    <link rel="stylesheet" href="assets/plugins/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/style.css">

    <!-- CSS Header and Footer -->
    <link rel="stylesheet" href="assets/css/headers/header-default.css">
    <link rel="stylesheet" href="assets/css/footers/footer-v1.css">

    <!-- CSS Implementing Plugins -->
    <link rel="stylesheet" href="assets/plugins/animate.css">
    <link rel="stylesheet" href="assets/plugins/line-icons/line-icons.css">
    <link rel="stylesheet" href="assets/plugins/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="assets/plugins/scrollbar/css/jquery.mCustomScrollbar.css">
    <link rel="stylesheet" href="assets/css/bootstrap-editable.css">
    <link rel="stylesheet" href="assets/css/jquery.jgrowl.min.css">

    <!-- CSS Page Style -->
    <link rel="stylesheet" href="assets/css/pages/profile.css">
    <link rel="stylesheet" href="assets/plugins/line-icons-pro/styles.css">

    <link rel="stylesheet" href="assets/plugins/sky-forms-pro/skyforms/css/sky-forms.css">
    <link rel="stylesheet" href="assets/plugins/sky-forms-pro/skyforms/custom/custom-sky-forms.css">


    <!-- CSS Theme -->
    <link rel="stylesheet" href="assets/css/theme-skins/dark.css" id="style_color">
    <link rel="stylesheet" href="assets/css/theme-colors/dark-red.css">

    <!-- CSS Customization -->
    <link rel="stylesheet" href="assets/css/custom.css">
    <!-- link rel="stylesheet" href="assets/css/custom_rfq.css" -->
    <link rel="stylesheet" href="assets/css/typeaheadjs.css">

</head>

<body>

<div class="wrapper">
    <!--=== Header ===-->
    <div id="header_p"></div>
    <!--=== End Header ===-->

    <!--=== Profile ===-->
    <div class="container content profile">
        <div class="row">

            <!--Left Sidebar-->
            <div id="sidebar" class="col-md-3" style="display: none;">

            </div>
            <!--End Left Sidebar-->
            <!-- Profile Content -->
            <div class="col-md-9">
                <div class="profile-body">
                    <div class="row">
                        <!--Alert-->
                        <div class="sm-margin-bottom-30 ">
                            <div class="panel-heading-v2 overflow-h">
                                <h2 class="heading-xs pull-left"><i class="fa fa-paper-plane fa-fw"></i> <span data-i18n="product.updateProduct"></span> </h2>
                                <div style="text-align: center">
                                    <div class="" style="display: inline-block;">
                                        <strong id="new-product-header" class="" style=""></strong>
                                    </div>
                                    <a href="#"><i class="fa fa-cog pull-right"></i></a>
                                </div>

                            </div>
                            <hr>
                            <div class="panel panel-profile">


                                <div id="inbox-new-product-container">

                                </div>
                            </div>
                        </div>
                    </div>
                    <!--End Alert-->

                </div><!--/end row-->

                <hr>


            </div>
            <!-- End Profile Content -->
        </div>
    </div><!--/container-->
    <!--=== End Profile ===-->

    <!--=== Footer Version 1 ===-->
    <div id="footer_p" ></div>

    <!--=== End Footer Version 1 ===-->
</div><!--/wrapper-->

<!-- JS Global Compulsory -->
<script type="text/javascript" src="assets/plugins/jquery/jquery.min.js"></script>
<script type="text/javascript" src="assets/plugins/jquery/jquery-migrate.min.js"></script>
<script type="text/javascript" src="assets/plugins/bootstrap/js/bootstrap.min.js"></script>
<!-- JS Implementing Plugins -->
<script type="text/javascript" src="assets/plugins/smoothScroll.js"></script>
<script type="text/javascript" src="assets/plugins/counter/waypoints.min.js"></script>
<script type="text/javascript" src="assets/plugins/counter/jquery.counterup.min.js"></script>
<script type="text/javascript" src="assets/plugins/sky-forms-pro/skyforms/js/jquery-ui.min.js"></script>
<script type="text/javascript" src="assets/plugins/sky-forms-pro/skyforms/js/jquery.validate.min.js"></script>
<script type="text/javascript" src="assets/plugins/scrollbar/js/jquery.mCustomScrollbar.concat.min.js"></script>

<!-- JS Translation -->
<script src="assets/js/translations/translation.js"></script>
<script type="text/javascript" src="assets/js/plugins/i18next.min.js"></script>
<script type="text/javascript" src="assets/js/plugins/jquery-i18next.min.js"></script>

<!-- JS Customization -->
<script type="text/javascript" src="assets/js/sidebar.js"></script>
<script type="text/javascript" src="assets/js/custom.js"></script>
<!-- JS Page Level -->
<script type="text/javascript" src="assets/js/app.js"></script>
<script type="text/javascript" src="assets/js/plugins/datepicker.js"></script>
<!--<script type="text/javascript" src="assets/js/plugins/style-switcher.js"></script>-->
<script type="text/javascript" src="assets/js/common_header.js"></script>

<script type="text/javascript" src="assets/js/plugins/handlebars.min.js"></script>

<script type="text/javascript" src="assets/js/plugins/bootstrap-editable.min.js"></script>
<script type="text/javascript" src="assets/js/plugins/jquery.jgrowl.min.js"></script>


<script type="text/javascript" src="assets/js/plugins/socket.io-1.4.5.js"></script>
<!-- script type="text/javascript" src="assets/js/custom_rfq.js"></script -->
<script type="text/javascript" src="assets/js/footer.js"></script>
<script type="text/javascript" src="assets/js/plugins/async.js"></script>
<script type="text/javascript" src="assets/js/utils.js"></script>
<script type="text/javascript" src="assets/js/plugins/typeahead.bundle.js"></script>
<script type="" src="assets/plugins/img-resize.js"></script>

<script type="text/javascript">

  jQuery(document).ready(function () {
      App.init();
      
      if(sessionStorage.userId == undefined || sessionStorage.type != "supplier")
      {      
        redirectToLogin();
      }
      
      var productId = getUrlParameter("pid");
      
      if(productId)
      {
        getProductInfo(productId);
      }
      else
      {
        // Errore
      }            
      
      $("#sidebar").show();

      var source = $("#new_prod_template").html();
      var theTemplate = Handlebars.compile(source);

      var theCompiledHtml = theTemplate();

      // Add the compiled html to the page
      $("#inbox-new-product-container").html(theCompiledHtml);

      $("body").localize();

      autoCompleteCat("categoryField");
  });
  
  
  var formats = 
  {
    formats:
    {
      o:
      {
        maxSize:800
      },
      t:
      {
        maxSize:80
      }
    }
  }
       
  var img = [];
  var imgCounter = 0;
  
  
  function getProductInfo(id)
  {
    jQuery.ajax({
      url: _brokerMsUrl + "products/" + id,
      type: "get",
      contentType: "application/json; charset=utf-8",
      //data: JSON.stringify(param),
      dataType: "json",
      success: function(dataResp, textStatus, xhr)
      {          
        jQuery("#name_it").val(dataResp.name);
        jQuery("#name_en").val(dataResp.translation[0].name);
        jQuery("#description_it").val(dataResp.description);
        jQuery("#description_en").val(dataResp.translation[0].description);
        jQuery("#qmin").val(dataResp.minNum);
        jQuery("#qmax").val(dataResp.maxNum);
        jQuery("#availability").val(dataResp.availability);
        jQuery("#price").val(dataResp.price);
        jQuery("#delin").val(dataResp.deliveryIn);        
        jQuery("#unit").val(dataResp.unit);
        
        var category = dataResp.categories;
        
        if(category && category[0])
        { 
          getCategoryName(category[0], function(data){
            jQuery("#categoryField").data("cat-name", data.name[localStorage.lng]);
            jQuery("#categoryField").val(data.name[localStorage.lng]);
            
          });                   
          jQuery("#categoryField").data("cat-id", category[0]);
          
          
          var pic = dataResp.images;
          
          if(pic && pic.length > 0)
          {
            var images = document.getElementById("attachedImg");
            jQuery(images).empty();
            
            for(var i in pic)
            {
              picId = pic[i].imageId;              
              
              var box = document.createElement("div");
              box.style.marginRight = "12px"
              box.style.position = "relative";
              box.style.border = "solid 1px #ddd";
              box.style.padding = "5px";
              box.style.display = "inline-block";
              
              var p = document.createElement("img");
              p.src = _brokerMsUrl + "files/" + picId + "?tag=t";
              p.style.maxWidth = "80px";              
              p.style.width = "100%";
              p.setClassName = "attachedPictures";
              p.setAttribute("data-id", picId);
                            
              var btn = document.createElement("div");
              btn.className = "glyphicon glyphicon-remove"
              btn.style.fontSize = "8pt";
              btn.style.cursor = "pointer";
              btn.style.position = "absolute";
              btn.style.top = "-9px";
              btn.style.right = "-9px";
              btn.style.padding = "2px";
              btn.style.backgroundColor = "#eee";
              btn.style.color = "#bc0000";
              btn.style.border = "solid 1px #999";
              btn.style.borderRadius = "50%";
              btn.onclick = function(){
                if(this.className == "glyphicon glyphicon-remove")
                {
                  this.className = "glyphicon glyphicon-repeat";
                  this.style.color = "#007d00";
                  var im = jQuery(this).parent().find("img").first()[0];
                  im.style.opacity = "0.15";      
                  im.setAttribute("data-erased", "true");
                }
                else
                {
                  this.className = "glyphicon glyphicon-remove";                
                  this.style.color = "#bc0000";
                  var im = jQuery(this).parent().find("img").first()[0];
                  im.style.opacity = "1";
                  im.removeAttribute("data-erased");                  
                }
              }
                            
              box.appendChild(p);
              box.appendChild(btn);
              images.appendChild(box);                                                        
            }
          }
          
        }                                
        // dataResp.id                    
        //jQuery.jGrowl(i18next.t("product.added"), {theme:'bg-color-green1', life: 5000});        
              
      },     
      error: function(xhr, status)
      {
        var msg;
        try
        {
          msg = xhr.responseJSON.message;
        }
        catch(err)
        {
          msg = i18next.t("error.internal_server_error");
        }
        
        jQuery.jGrowl(msg, {theme:'bg-color-red', life: 5000});
              
        return;    
      },
      beforeSend: function(xhr, settings) 
      { 
        xhr.setRequestHeader('Authorization','Bearer ' + sessionStorage.token); 
      }                    
    });          
    
  }
  
  
  
  function addImgId(data)
  {
    img.push(data.filecode);
    imgCounter--;
        
    
    if(imgCounter == 0)
    {
      sendUpdateRequest();
    }
  }
  
  function onErrorUpload(data)
  {
    imgCounter--;    
    
    if(imgCounter == 0)
    {
      sendUpdateRequest();
    }
  }
  
  
        
  function sendUpdateRequest()
  {
    var param = {};

    param.translation = [{"language" : "english"}];
    
    param.name = jQuery("#name_it").val();
    param.translation[0].name = jQuery("#name_en").val();
    param.categories = jQuery("#categoryField").data("cat-id");
    param.description = jQuery("#description_it").val();
    param.translation[0].description = jQuery("#description_en").val();
    param.unit = jQuery("#unit").val();
        
    param.minNum = jQuery("#qmin").val();
    param.maxNum = jQuery("#qmax").val();
    param.deliveryIn = jQuery("#delin").val();
    param.price = jQuery("#price").val();
    param.availability = jQuery("#availability").val();              

    if(param.minNum.trim() == "")
      delete param.minNum
      
    if(param.maxNum.trim() == "")
      delete param.maxNum
      
    if(param.deliveryIn.trim() == "")
      delete param.deliveryIn
      
    if(param.price.trim() == "")
      delete param.price
      
    if(param.availability.trim() == "")
      delete param.availability
        
    if(param.name.trim() == "")
    {
      var msg = i18next.t("error.void_name");
      jQuery.jGrowl(msg, {theme:'bg-color-red', life: 5000});
      return;
    }
    
    if(param.categories.trim() == "")
    {
      var msg = i18next.t("error.void_category");
      jQuery.jGrowl(msg, {theme:'bg-color-red', life: 5000});
      return;
    }
    else
    {
      param.categories = [param.categories];
    }
    
    if(param.unit.trim() == "")
    {
      var msg = i18next.t("error.void_unit");
      jQuery.jGrowl(msg, {theme:'bg-color-red', life: 5000});
      return;
    }
    
    if(param.description.trim() == "")
    {
      var msg = i18next.t("error.void_desc");
      jQuery.jGrowl(msg, {theme:'bg-color-red', life: 5000});
      return;
    }
    
    jQuery("#attachedImg img").each(function(){
      if(param.images == undefined)
      {        
        param.images = [];
      }
          
      if(!this.hasAttribute("data-erased"))
      {                  
        param.images.push({"imageId": this.getAttribute("data-id")});
      }
                
    })    
    
    if(img.length > 0)
    {
      if(param.images == undefined)
          param.images = [];      
      
      for(var i in img)
      {        
        param.images.push({"imageId" : img[i]});
      }
    }
    
    jQuery.ajax({
      url: _brokerMsUrl + "products/" + getUrlParameter("pid"),
      type: "PUT",
      contentType: "application/json; charset=utf-8",
      data: JSON.stringify(param),
      dataType: "json",
      success: function(dataResp, textStatus, xhr)
      {          
        // dataResp.id                    
        jQuery.jGrowl(i18next.t("product.updated"), {theme:'bg-color-green1', life: 5000});    
        getProductInfo(getUrlParameter("pid"));                  
      },     
      error: function(xhr, status)
      {
        var msg;
        try
        {
          msg = xhr.responseJSON.message;
        }
        catch(err)
        {
          msg = i18next.t("error.internal_server_error");
        }
        
        jQuery.jGrowl(msg, {theme:'bg-color-red', life: 5000});
              
        return;    
      },
      beforeSend: function(xhr, settings) 
      { 
        xhr.setRequestHeader('Authorization','Bearer ' + sessionStorage.token);
      }                    
    });        
  }
    
  function updateProduct()
  {
    if(sessionStorage.userId == undefined)
    {      
      redirectToLogin();
    }
    
    img = [];
    imgCounter = 0;
                
    var iid = [];
    
    jQuery("#imgBlock input").each(function(){      
      if(this.files.length > 0)
      {
        iid.push(this.id);            
      }            
    });
    
    imgCounter = iid.length;
            
      
    if(imgCounter == 0)
    {
      sendUpdateRequest();
    }
    
    for(var i in iid)
    {
      resizeImage(iid[i], _brokerMsUrl + "files/" , addImgId, onErrorUpload, formats, function(xhr, settings){
         xhr.setRequestHeader('Authorization','Bearer ' + sessionStorage.token);      
      });
    }
    
    jQuery("#attachedImg img").each(function(){     
      if(this.hasAttribute("data-erased"))
      {  
        removeImage(this.getAttribute("data-id"),  getUrlParameter("pid"));                        
      }                
    })                      
      
  }
  
  function addImgInput()
  {
    var box = document.createElement("div");
    box.style.marginBottom = "5px";
    
    var bt = document.createElement("button");
    bt.setAttribute("onclick", "jQuery(this.parentNode).remove();");    
    bt.className = "btn-u";
    bt.style.display = "inline-block"
    bt.style.marginRight = "10px";
            
    var ic = document.createElement("span");
    ic.className = "glyphicon glyphicon-remove";
    ic.setAttribute("aria-hidden", true);
        
    bt.appendChild(ic);
    
    var i = document.createElement("input");
    i.type = "file";
    i.style.display = "inline-block";
    
    var idx = 0;
    
    jQuery("#imgBlock input").each(function(){
      var id = jQuery(this).attr("id");
      idx = id.split("_")[1];
    });
    
    i.id = "prod-img_" + (++idx);
    
    box.appendChild(bt);
    box.appendChild(i);
    
    document.getElementById("imgBlock").appendChild(box);                          
  }
    
    
    
</script>
<!--[if lt IE 9]>
<script src="assets/plugins/respond.js"></script>
<script src="assets/plugins/html5shiv.js"></script>
<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
<script src="assets/plugins/sky-forms-pro/skyforms/js/sky-forms-ie8.js"></script>

<![endif]-->

<!--[if lt IE 10]>
<script src="assets/plugins/sky-forms-pro/skyforms/js/jquery.placeholder.min.js"></script>
<![endif]-->

<script id="new_prod_template" type="text/x-handlebars-template">
    <div class="sky-form">

        <fieldset>

            <div class="row">
                <section class="col col-6">
                    <label class="label" data-i18n="product.category"></label>
                    <label class="input">
                      <!--  <select name="gender">
                            <option value="0" selected="" disabled="">Pasta fresca</option>
                            <option value="1">Pesce</option>
                            <option value="2">Formaggio</option>
                            <option value="3">Dolci</option>
                        </select>-->
                        <input type="text" name="name" id="categoryField">

                    </label>
                </section>


                  <section class="col col-11" style="border: solid 1px #ddd; padding:5px;">
                    <h4 style="width:40px; margin-top: -20px; margin-left:5px; background:white; text-align:center">IT</h4>
                    <label class="label" data-i18n="profile.name"></label>
                    <label class="input">
                        <i class="icon-append  icon-target"></i>
                        <input type="text" name="name" id="name_it">
                    </label>

                    <label class="label" data-i18n="profile.description"></label>
                    <label class="textarea">
                      <textarea rows="3" id="description_it"></textarea>
                    </label>
                    <div class="note"><strong data.i18n="product.note">Note: </strong><span data-i18n="product.maxCharacters">massimo 500 caratteri.</span></div>
                  </section>

                  <section class="col col-11" style="border: solid 1px #ddd; padding:5px;">
                    <h4 style="width:40px; margin-top: -20px; margin-left:5px; background:white; text-align:center">EN</h4>
                    <label class="label" data-i18n="profile.name"></label>
                    <label class="input">
                        <i class="icon-append  icon-target"></i>
                        <input type="text" name="name" id="name_en">
                    </label>
                    <label class="label" data-i18n="profile.description"></label>
                    <label class="textarea">
                      <textarea rows="3" id="description_en"></textarea>
                    </label>
                    <div class="note"><strong data.i18n="product.note">Note: </strong><span data-i18n="product.maxCharacters">massimo 500 caratteri.</span></div>
                  </section>

            </div>


            <div class="row" >

                <section class="col col-3">
                    <label class="label" data-i18n="catalog.atleast"></label>
                    <label class="input">
                        <i class="icon-append   icon-arrow-down"></i>
                        <input id="qmin"type="text" data-i18n="[placeholder]product.minimumQuantity" >
                    </label>
                </section>

                <section class="col col-3">
                    <label class="label" data-i18n="catalog.atmost"></label>
                    <label class="input">
                        <i class="icon-append   icon-arrow-up"></i>
                        <input id="qmax" type="text"  data-i18n="[placeholder]product.maximumQuantity" name="product">
                    </label>
                </section>
                
                <section class="col col-3">
                    <label class="label" data-i18n="catalog.unit"></label>
                    <label class="select">
                        <select id="unit" >
                          <option value="unty" data-i18n="rfq.unty"></option>
                          <option value="kg" data-i18n="rfq.kg"></option>
                          <option value="mtr" data-i18n="rfq.mtr"></option>
                          <option value="ltr" data-i18n="rfq.ltr"></option>
                          <option value="fot" data-i18n="rfq.fot"></option>
                          <option value="lbr" data-i18n="rfq.lbr"></option>
                          <option value="g" data-i18n="rfq.g"></option>
                        </select>
                    </label>
                </section>
                
                <section class="col col-3">
                    <label class="label" data-i18n="catalog.availability"></label>
                    <label class="input">
                        <i class="icon-append  icon-layers"></i>
                        <input id="availability" type="text" data-i18n="[placeholder]catalog.availability" >
                    </label>
                </section>
                
                <section class="col col-3">
                    <label class="label" data-i18n="catalog.deliveryIn"></label>
                    <label class="input">
                        <i class="icon-append  icon-calendar"></i>
                        <input id="delin" type="text"  data-i18n="[placeholder]product.numberOfDays">
                    </label>
                </section>
                <section class="col col-3">
                    <label class="label" data-i18n="catalog.price"></label>
                    <label class="input">
                        <i class="icon-append   icon-finance-246"></i>
                        <input id="price" type="text"  >
                    </label>
                </section>
                
                <!-- section class="col col-5">
                    <label class="label" >File</label>
                    <label class="input input-file" for="file">
                        <div class="button"><input class="imgInput" onchange="this.parentNode.nextSibling.nextSibling.value = this.value " type="file">Browse</div>
                        <input class="fl" readonly="" type="text"> 
                    </label>
                </section -->
                
                

            </div>
            <section class="col col-11">
              <label class="label" data-i18n="product.images"></label>              
                            
              <div class="row" id="imgBlock" style="border: solid 1px #ddd; padding:15px ">
                <div class="row" id="attachedImg">                              
                </div>
                <hr>
                <div>
                  <button onclick="addImgInput()" class="btn-u btn-u-default" style="float:left"><span class="glyphicon glyphicon-plus" aria-hidden="true"></span></button>
                </div>
                <br><br>
                <div style="margin-bottom:5px">                              
                  <button onclick="jQuery(this.parentNode).remove()" class="btn-u" style="display:inline-block; margin-right: 10px"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span></button>
                  <input type="file" id="prod-img_1" style="display:inline-block">
                </div>
              </div>
            </section>

        </fieldset>

        <hr>
        <div class="input-group">
            <button onclick="updateProduct()" class="btn-u" data-i18n="profile.save"></button>
        </div>

    </div>
</script>
<!--End Template New Product-->


</body>
</html>

