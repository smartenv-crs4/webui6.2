<!DOCTYPE html>
<!--[if IE 8]> <html lang="en" class="ie8"> <![endif]-->
<!--[if IE 9]> <html lang="en" class="ie9"> <![endif]-->
<!--[if !IE]><!--> <html lang="en"> <!--<![endif]-->
<head>
  <title>Administration Area</title>

  <!-- Meta -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!-- Favicon -->
  <link rel="shortcut icon" href="favicon.ico">

  <!-- Web Fonts -->  
  <!-- link rel='stylesheet' type='text/css' href='https://fonts.googleapis.com/css?family=Open+Sans:400,300,600&amp;subset=cyrillic,latin' -->


  <!-- CSS Global Compulsory -->
  <link rel="stylesheet" href="assets/plugins/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" href="assets/css/style.css">
  <link rel="stylesheet" href="assets/css/plugins/bootstrap-select.min.css">

  <!-- CSS Header and Footer -->
  <link rel="stylesheet" href="assets/css/headers/header-default.css">
  <link rel="stylesheet" href="assets/css/footers/footer-v1.css">


  <!-- CSS Implementing Plugins -->
  <link rel="stylesheet" href="assets/plugins/animate.css">
  <link rel="stylesheet" href="assets/plugins/line-icons/line-icons.css">
  <link rel="stylesheet" href="assets/plugins/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="assets/plugins/scrollbar/css/jquery.mCustomScrollbar.css">
  <link rel="stylesheet" href="assets/plugins/sky-forms-pro/skyforms/css/sky-forms.css">
  <link rel="stylesheet" href="assets/plugins/sky-forms-pro/skyforms/custom/custom-sky-forms.css">

  <!-- CSS Page Style -->
  <link rel="stylesheet" href="assets/css/pages/profile.css">

  <!-- CSS Theme -->
  <link rel="stylesheet" href="assets/css/theme-skins/dark.css" id="style_color">
  <link rel="stylesheet" href="assets/css/theme-colors/dark-red.css">

  <!-- CSS Customization -->
  <link rel="stylesheet" href="assets/css/custom.css">
  <link rel="stylesheet" href="assets/css/bootstrap-editable.css">

  <link rel="stylesheet" href="assets/css/jquery.jgrowl.min.css">
  
  <link rel="stylesheet" href="assets/css/typeaheadjs.css">  

  <!-- CSS Page Style Import-->
  <link rel="stylesheet" href="assets/css/pages/page_log_reg_v3.css">
  
  <style type="text/css">
        .giveMeEllipsis {
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 5; /* number of lines to show */
            /*  line-height: 1;  fallback */
            max-height: 5; /* fallback */
        }

        .sidebar-showhide {
            max-width: 25%;
            float: left;
            display: flex;
            padding: 15px;
            padding-top: 0;
        }

        .autoexpand {
            width: auto;
            display: flex;
        }

        #pagination_container {
            display: block;
            margin-right: auto;
            margin-left: auto;
            max-width: 530px;
            width: 530px;
        }
    </style>
    <script id="edit_prod_template" type="text/x-handlebars-template">
      <div class="sky-form">
        <fieldset>

            <div class="row">
                <section class="col col-6">
                    <label class="label" data-i18n="product.category"></label>
                    <label class="input">
                      <!--  <select name="gender">
                            <option value="0" selected="" disabled="">Pasta fresca</option>
                            <option value="1">Pesce</option>
                            <option value="2">Formaggio</option>
                            <option value="3">Dolci</option>
                        </select>-->
                        <input type="text" name="name" id="categoryField">

                    </label>
                </section>


                  <section class="col col-11" style="border: solid 1px #ddd; padding:5px;">
                    <h4 style="width:40px; margin-top: -20px; margin-left:5px; background:white; text-align:center">IT</h4>
                    <label class="label" data-i18n="profile.name"></label>
                    <label class="input">
                        <i class="icon-append  icon-target"></i>
                        <input type="text" name="name" id="name_it">
                    </label>

                    <label class="label" data-i18n="profile.description"></label>
                    <label class="textarea">
                      <textarea rows="3" id="description_it"></textarea>
                    </label>
                    <div class="note"><strong data.i18n="product.note">Note: </strong><span data-i18n="product.maxCharacters">massimo 500 caratteri.</span></div>
                  </section>

                  <section class="col col-11" style="border: solid 1px #ddd; padding:5px;">
                    <h4 style="width:40px; margin-top: -20px; margin-left:5px; background:white; text-align:center">EN</h4>
                    <label class="label" data-i18n="profile.name"></label>
                    <label class="input">
                        <i class="icon-append  icon-target"></i>
                        <input type="text" name="name" id="name_en">
                    </label>
                    <label class="label" data-i18n="profile.description"></label>
                    <label class="textarea">
                      <textarea rows="3" id="description_en"></textarea>
                    </label>
                    <div class="note"><strong data.i18n="product.note">Note: </strong><span data-i18n="product.maxCharacters">massimo 500 caratteri.</span></div>
                  </section>

            </div>


            <div class="row" >

                <section class="col col-3" id="qmin_box">
                    <label class="label" data-i18n="catalog.atleast"></label>
                    <label class="input">
                        <i class="icon-append   icon-arrow-down"></i>
                        <input id="qmin"type="text" data-i18n="[placeholder]product.minimumQuantity" >
                    </label>
                </section>

                <section class="col col-3" id="qmax_box">
                    <label class="label" data-i18n="catalog.atmost"></label>
                    <label class="input">
                        <i class="icon-append   icon-arrow-up"></i>
                        <input id="qmax" type="text"  data-i18n="[placeholder]product.maximumQuantity" name="product">
                    </label>
                </section>
                
                <section class="col col-3" id="unit_box">
                    <label class="label" data-i18n="catalog.unit"></label>
                    <label class="select">
                        <select id="unit" >
                          <option value="unty" data-i18n="rfq.unty"></option>
                          <option value="kg" data-i18n="rfq.kg"></option>
                          <option value="mtr" data-i18n="rfq.mtr"></option>
                          <option value="ltr" data-i18n="rfq.ltr"></option>
                          <option value="fot" data-i18n="rfq.fot"></option>
                          <option value="lbr" data-i18n="rfq.lbr"></option>
                          <option value="g" data-i18n="rfq.g"></option>
                        </select>
                    </label>
                </section>
                
                <section class="col col-3" id="availability_box">
                    <label class="label" data-i18n="catalog.availability"></label>
                    <label class="input">
                        <i class="icon-append  icon-layers"></i>
                        <input id="availability" type="text" data-i18n="[placeholder]catalog.availability" >
                    </label>
                </section>
                
                <section class="col col-3" id="deliveryIn_box">
                    <label class="label" data-i18n="catalog.deliveryIn"></label>
                    <label class="input">
                        <i class="icon-append  icon-calendar"></i>
                        <input id="delin" type="text"  data-i18n="[placeholder]product.numberOfDays">
                    </label>
                </section>
                <section class="col col-3" id="price_box">
                    <label class="label" data-i18n="catalog.price"></label>
                    <label class="input">
                        <i class="icon-append   icon-finance-246"></i>
                        <input id="price" type="text"  >
                    </label>
                </section>
                
                <!-- section class="col col-5">
                    <label class="label" >File</label>
                    <label class="input input-file" for="file">
                        <div class="button"><input class="imgInput" onchange="this.parentNode.nextSibling.nextSibling.value = this.value " type="file">Browse</div>
                        <input class="fl" readonly="" type="text"> 
                    </label>
                </section -->
                
                

            </div>
            <section class="col col-11">
              <label class="label" data-i18n="product.images"></label>              
                            
              <div class="row" id="imgBlock" style="border: solid 1px #ddd; padding:15px ">
                <div class="row" id="attachedImg">                              
                </div>
              </div>
            </section>

        </fieldset>
          
        <hr>
        <input type="hidden" id="editProductId" />
        <div class="input-group">
            <button onclick="updateProduct()" class="btn-u" data-i18n="profile.save"></button>
        </div>

    </div>
</script>

    <script type="text/javascript">
      function deleteProduct()
      {
        var pid = jQuery(this)[0].getAttribute('data-id');
        var page  = jQuery(this)[0].getAttribute('data-page');
        var sid  = jQuery(this)[0].getAttribute('data-sid');

        jQuery.ajax({
          url: _brokerMsUrl + "admin/products/" + pid,
          type: "DELETE",
          contentType: "application/json; charset=utf-8",
          success: function(data, textStatus, xhr)
          {
            jQuery.jGrowl("Success", {theme:'bg-color-green', life: 5000});
            getProducts(sid, page)
          },
          error: function(xhr, status)
          {
            var errMsg = "Internal Server Error";

            if(xhr.responseJSON.error_message)
              errMsg = xhr.responseJSON.error_message;
            else if(xhr.responseJSON.message)
              errMsg = xhr.responseJSON.message;

            jQuery.jGrowl(errMsg, {theme:'bg-color-red', life: 5000});
          },
          beforeSend: function(xhr, settings)
          {
            xhr.setRequestHeader('Authorization','Bearer ' + sessionStorage.token);
          }
        });
      }

      function setPassword()
      {
        var data = {};

        var bEdit = jQuery(".userEdit").first(); 
        var uid = bEdit.attr("id").split("-")[1];
        var password = jQuery("#ed-password").val();

        data.newpassword = password;

        //console.log(sessionStorage.token);
        jQuery.ajax({
          url: _brokerMsUrl + "admin/users/" + uid + "/actions/setpassword",
          type: "POST",
          contentType: "application/json; charset=utf-8",
          data: JSON.stringify(data),
          dataType: "json",
          success: function(dataResp, textStatus, xhr)
          {  
            jQuery('.editable-unsaved').removeClass('editable-unsaved');
            jQuery.jGrowl(i18next.t("profile.saved"), {theme:'bg-color-green1', life: 5000});            
          },     
          error: function(xhr, status)
          {
            var msg;
            try
            {
              msg = xhr.responseJSON.message;
            }
            catch(err)
            {
              msg = i18next.t("error.internal_server_error");
            }
            
            jQuery.jGrowl(msg, {theme:'bg-color-red', life: 5000});
                  
            return;    
          },
          beforeSend: function(xhr, settings) 
          { 
            xhr.setRequestHeader('Authorization','Bearer ' + sessionStorage.token); 
          }                    
        });  
      }

      function a_removeImage(iid)
      {
        jQuery.ajax({
          url: _brokerMsUrl + "admin/images/" + iid,
          type: "DELETE",
          success: function(data){
          },
          error: function(xhr)
          {
            console.log("image " + iid + " doesn't removed")
          },
          beforeSend: function(xhr, settings)
          {
            xhr.setRequestHeader('Authorization','Bearer ' + sessionStorage.token);
          }
        });
      }

      function updateProduct()
      {
        var pid = jQuery("#editProductId").val();

        jQuery("#attachedImg img").each(function(){     
          if(this.hasAttribute("data-erased"))
          {  
            a_removeImage(this.getAttribute("data-id"));                        
          }                
        });
    
        var param = {};

        param.translation = [{"language" : "english"}];
        
        param.name = jQuery("#name_it").val();
        param.translation[0].name = jQuery("#name_en").val();
        param.categories = jQuery("#categoryField").data("cat-id");
        param.description = jQuery("#description_it").val();
        param.translation[0].description = jQuery("#description_en").val();
        param.unit = jQuery("#unit").val();
            
        param.minNum = jQuery("#qmin").val();
        param.maxNum = jQuery("#qmax").val();
        param.deliveryIn = jQuery("#delin").val();
        param.price = jQuery("#price").val();
        param.availability = jQuery("#availability").val();

        if(param.name.trim() == "")
        {
          var msg = i18next.t("error.void_name");
          jQuery.jGrowl(msg, {theme:'bg-color-red', life: 5000});
          return;
        }
        
        if(param.categories.trim() == "")
        {
          var msg = i18next.t("error.void_category");
          jQuery.jGrowl(msg, {theme:'bg-color-red', life: 5000});
          return;
        }
        else
        {
          param.categories = [param.categories];
        }
        
        if(jQuery("#categoryField").data("type") === 1 && (!param.unit || param.unit.trim() == "" ))
        {
          var msg = i18next.t("error.void_unit");
          jQuery.jGrowl(msg, {theme:'bg-color-red', life: 5000});
          return;
        }

        if(param.description.trim() == "")
        {
          var msg = i18next.t("error.void_desc");
          jQuery.jGrowl(msg, {theme:'bg-color-red', life: 5000});
          return;
        }
        
        jQuery("#attachedImg img").each(function(){
          if(param.images == undefined)
          {        
            param.images = [];
          }
              
          if(!this.hasAttribute("data-erased"))
          {                  
            param.images.push({"imageId": this.getAttribute("data-id")});
          }
                    
        })    
        
        //console.log(sessionStorage.token);
        jQuery.ajax({
          url: _brokerMsUrl + "admin/products/" + pid,
          type: "PUT",
          contentType: "application/json; charset=utf-8",
          data: JSON.stringify(param),
          dataType: "json",
          success: function(dataResp, textStatus, xhr)
          {  
            jQuery('.editable-unsaved').removeClass('editable-unsaved');
            
            jQuery.jGrowl(i18next.t("profile.saved"), {theme:'bg-color-green1', life: 5000});            
          },     
          error: function(xhr, status)
          {
            var msg;
            try
            {
              msg = xhr.responseJSON.message;
            }
            catch(err)
            {
              msg = i18next.t("error.internal_server_error");
            }
            
            jQuery.jGrowl(msg, {theme:'bg-color-red', life: 5000});
                  
            return;    
          },
          beforeSend: function(xhr, settings) 
          { 
            xhr.setRequestHeader('Authorization','Bearer ' + sessionStorage.token); 
          }                    
        });  
      }


      function updateUserProfile()
      {
        var data = new Object();
        data.user = new Object();
        
        var bEdit = jQuery(".userEdit").first(); 
        data.uid = bEdit.attr("id").split("-")[1];

        bEdit.find(".editable").each(function(){
          var name = jQuery(this).data("name");
          var value = jQuery(this).editable('getValue')[name];
          if(value || jQuery(this).hasClass("editable-unsaved"))
          {
            if(name.indexOf(".") >= 0)
            {
              var sName = name.split(".");
              if(data.user[sName[0]] == undefined)
              {
                data.user[sName[0]] = {};          
              }
              data.user[sName[0]][sName[1]] = value;
            }
            else
            {
              data.user[name] = value;    
            }
          }
        });
        
        //console.log(sessionStorage.token);
        jQuery.ajax({
          url: _brokerMsUrl + "admin/users",
          type: "PUT",
          contentType: "application/json; charset=utf-8",
          data: JSON.stringify(data),
          dataType: "json",
          success: function(dataResp, textStatus, xhr)
          {  
            jQuery('.editable-unsaved').removeClass('editable-unsaved');
            jQuery.jGrowl(i18next.t("profile.saved"), {theme:'bg-color-green1', life: 5000});            
          },     
          error: function(xhr, status)
          {
            var msg;
            try
            {
              msg = xhr.responseJSON.message;
            }
            catch(err)
            {
              msg = i18next.t("error.internal_server_error");
            }
            
            jQuery.jGrowl(msg, {theme:'bg-color-red', life: 5000});
                  
            return;    
          },
          beforeSend: function(xhr, settings) 
          { 
            xhr.setRequestHeader('Authorization','Bearer ' + sessionStorage.token); 
          }                    
        });  
      }

      function deleteUser()
      {
        var uid = jQuery(this)[0].getAttribute('data-id');

        var page = jQuery("#user-paginator li.active").first().children().first().html();
        console.log(page);

        jQuery.ajax({
          url: _brokerMsUrl + "admin/users/" + uid,
          type: "DELETE",
          contentType: "application/json; charset=utf-8",
          success: function(data, textStatus, xhr)
          {
            jQuery.jGrowl("Success", {theme:'bg-color-green', life: 5000});
            filterResults(page);
          },
          error: function(xhr, status)
          {
            var errMsg = "Internal Server Error";

            if(xhr.responseJSON.error_message)
              errMsg = xhr.responseJSON.error_message;
            else if(xhr.responseJSON.message)
              errMsg = xhr.responseJSON.message;

            jQuery.jGrowl(errMsg, {theme:'bg-color-red', life: 5000});
          },
          beforeSend: function(xhr, settings)
          {
            xhr.setRequestHeader('Authorization','Bearer ' + sessionStorage.token);
          }
        });
      }

      function getUserProfile(uid)
      {
        jQuery.ajax(
        {
          url: _brokerMsUrl + "admin/users/" + uid,
          type: "GET",
          contentType: "application/json; charset=utf-8",
          success: function(data, textStatus, xhr)
          {  
          var defaultImg = "assets/img/team/img32-md.jpg";

          // success
          if(data.type == "customer")
          {
            data.typeTranslate = i18next.t("profile.customer");
            var template = Handlebars.compile(customerProfileTemplate); 
            jQuery('#edit-' + uid).html(template(data));                      
            jQuery('#edit-' + uid).localize();
          }
          else if(data.type == "supplier")
          {
            data.typeTranslate = i18next.t("profile.supplier");
            var template = Handlebars.compile(supplierProfileTemplate); 
            jQuery('#edit-' + uid).html(template(data));
            jQuery('#edit-' + uid).localize();

          }  
          else if(data.type == "admin")
          {
            data.typeTranslate = i18next.t("profile.admin");
            var template = Handlebars.compile(adminProfileTemplate); 
            jQuery('#edit-' + uid).html(template(data));                      
            jQuery('#edit-' + uid).localize();
          }

          jQuery(".editable").editable();
          jQuery(".editable").css("color", "black");

          jQuery(document).on("translate", function(){   
              var aType = jQuery("#pType").data("accounttype");        
              if(aType == "customer")
              jQuery("#pType").html(i18next.t("profile.customer"));
              else if(aType == "supplier")
              {
              jQuery("#pType").html(i18next.t("profile.supplier"));
              jQuery("#documentInput").filestyle('buttonText', i18next.t("profile.documentsInputLabel"));            
              }

              jQuery(".editable").each(function(){          
                jQuery(this).editable("option", "emptytext", jQuery(this).data("emptytext"));          
                });               
              jQuery(".editable-empty").each(function(){
                jQuery(this).html(jQuery(this).data("emptytext"));          
                });


              jQuery('[data-toggle=confirmation]').confirmation("destroy");            
              jQuery('[data-toggle=confirmation]').popover("destroy");
              jQuery('[data-toggle=confirmation]').attr('data-original-title', i18next.t("profile.areYouSure"));
              //jQuery('[data-toggle=confirmation]').attr('data-btn-cancel-label', i18next.t("profile.no"));
              //jQuery('[data-toggle=confirmation]').attr('data-btn-ok-label', i18next.t("profile.yes"));

              jQuery('[data-toggle=confirmation]').confirmation(
              {
                rootSelector: '[data-toggle=confirmation]',
                btnOkLabel: i18next.t("profile.yes"),
                btnCancelLabel: i18next.t("profile.no"),
                title: i18next.t("profile.areYouSure")      
              });
            });

          },     
          error: function(xhr, status)
          {      
            switch(xhr.status)
            {
              case 400: 
                if(xhr.responseJSON.error == "invalid_token")
                {
                  jQuery.jGrowl(i18next.t("error.unauthorized"), {theme:'bg-color-red', life: 5000});
                  redirectToLogin();
                }
                else if(xhr.responseJSON.error == "BadRequest")
                  jQuery.jGrowl(i18next.t("error.missing_user_or_password"), {theme:'bg-color-red', life: 5000});
                else
                  jQuery.jGrowl(xhr.responseJSON.error_message, {theme:'bg-color-red', life: 5000});
                break;
              case 401:
                jQuery.jGrowl(i18next.t("error.unauthorized"), {theme:'bg-color-red', life: 5000});
                redirectToLogin();
                break;
              case 500:
                jQuery.jGrowl(i18next.t("error.internal_server_error"), {theme:'bg-color-red', life: 5000});
                break;        
              default:
                jQuery.jGrowl(xhr.responseJSON.error_message, {theme:'bg-color-red', life: 5000});
            }
            return;    
          },
          beforeSend: function(xhr, settings) 
          { 
            xhr.setRequestHeader('Authorization','Bearer ' + sessionStorage.token); 
          }                    
        });        
      }

      function editUser(uid, type, email)
      {   
        jQuery(".dynamicTabEdit").remove();

        var tabContainer = jQuery("#tabContainer");
        tabContainer.find(".active").removeClass("active");
        var li = document.createElement("li");
        li.className = "tab-bar dynamicTabEdit";
        var a = document.createElement("a");
        a.setAttribute("data-toggle", "tab");
        a.setAttribute("href", "#edit-" + uid);
        a.setAttribute("aria-expanded", "true");
        a.innerHTML = "Edit " + email;

        li.appendChild(a);
        tabContainer.append(li);

        var tBodyContainer = jQuery("#tabBodyContainer");        
        tBodyContainer.find(".active").removeClass("active");

        var div = document.createElement("div");
        div.id = "edit-" + uid;
        div.className = "tab-pane fade in dynamicTabEdit userEdit";
        tBodyContainer.append(div);

        li.className = li.className + " active";
        div.className = div.className + " active";

        getUserProfile(uid);
      }


      function editProduct(pid, name, pObj)
      {
        var dataResp = JSON.parse(atob(pObj)); 
        jQuery(".dynamicTabEditProduct").remove();

        var tabContainer = jQuery("#tabContainerProducts");
        tabContainer.find(".active").removeClass("active");
        var li = document.createElement("li");
        li.className = "tab-bar dynamicTabEditProduct";
        var a = document.createElement("a");
        a.setAttribute("data-toggle", "tab");
        a.setAttribute("href", "#editProduct-" + pid);
        a.setAttribute("aria-expanded", "true");
        a.innerHTML = "Edit " + name;

        li.appendChild(a);
        tabContainer.append(li);

        var tBodyContainer = jQuery("#tabBodyContainerProducts");        
        tBodyContainer.find(".active").removeClass("active");

        var div = document.createElement("div");
        div.id = "editProduct-" + pid;
        div.className = "tab-pane fade in dynamicTabEditProduct productEdit";
        tBodyContainer.append(div);

        li.className = li.className + " active";
        div.className = div.className + " active";

        var source = $("#edit_prod_template").html();
        var template = Handlebars.compile(source);

        var compiledHtml = template();
        jQuery(div).html(compiledHtml);
        
        autoCompleteCat("categoryField", function(datum)
        {
          if(datum.type == 2)
          {
            jQuery("#qmin_box").hide();
            jQuery("#qmin").val("");

            jQuery("#qmax_box").hide();
            jQuery("#qmax").val("");

            jQuery("#unit_box").hide();
            jQuery("#unit").val("");

            jQuery("#availability_box").hide();
            jQuery("#availability").val("");
          }
          else
          {
            jQuery("#qmin_box").show();
            jQuery("#qmax_box").show();
            jQuery("#unit_box").show();
            jQuery("#availability_box").show();
          }
        });

        //getUserProfile(uid);

        jQuery("#name_it").val(dataResp.name);
        jQuery("#name_en").val(dataResp.translation[0].name);
        jQuery("#description_it").val(dataResp.description);
        jQuery("#description_en").val(dataResp.translation[0].description);
        jQuery("#qmin").val(dataResp.minNum);
        jQuery("#qmax").val(dataResp.maxNum);
        jQuery("#availability").val(dataResp.availability);
        jQuery("#price").val(dataResp.price);
        jQuery("#delin").val(dataResp.deliveryIn);        
        jQuery("#unit").val(dataResp.unit);
        jQuery("#editProductId").val(pid);
        
        var category = dataResp.categories;
        
        if(category && category[0])
        {          
          getCategoryName(category[0], function(data){
            jQuery("#categoryField").data("cat-type", data.type);
            jQuery("#categoryField").data("cat-name", data.name[localStorage.lng]);
            jQuery("#categoryField").val(data.name[localStorage.lng]);

            if(data.type != 1)
            {
              jQuery("#qmin_box").hide();
              jQuery("#qmax_box").hide();
              jQuery("#availability_box").hide();
              jQuery("#unit_box").hide();
            }
            
          });

          jQuery("#categoryField").data("cat-id", category[0]);
          
          var pic = dataResp.images;
          
          if(pic && pic.length > 0)
          {
            var images = document.getElementById("attachedImg");
            jQuery(images).empty();
            
            for(var i in pic)
            {
              picId = pic[i].imageId;              
              
              var box = document.createElement("div");
              box.style.marginRight = "12px"
              box.style.position = "relative";
              box.style.border = "solid 1px #ddd";
              box.style.padding = "5px";
              box.style.display = "inline-block";
              
              var p = document.createElement("img");
              p.src = _brokerMsUrl + "files/" + picId + "?tag=t";
              p.style.maxWidth = "80px";              
              p.style.width = "100%";
              p.setClassName = "attachedPictures";
              p.setAttribute("data-id", picId);
                            
              var btn = document.createElement("div");
              btn.className = "glyphicon glyphicon-remove"
              btn.style.fontSize = "8pt";
              btn.style.cursor = "pointer";
              btn.style.position = "absolute";
              btn.style.top = "-9px";
              btn.style.right = "-9px";
              btn.style.padding = "2px";
              btn.style.backgroundColor = "#eee";
              btn.style.color = "#bc0000";
              btn.style.border = "solid 1px #999";
              btn.style.borderRadius = "50%";
              btn.onclick = function(){
                if(this.className == "glyphicon glyphicon-remove")
                {
                  this.className = "glyphicon glyphicon-repeat";
                  this.style.color = "#007d00";
                  var im = jQuery(this).parent().find("img").first()[0];
                  im.style.opacity = "0.15";      
                  im.setAttribute("data-erased", "true");
                }
                else
                {
                  this.className = "glyphicon glyphicon-remove";                
                  this.style.color = "#bc0000";
                  var im = jQuery(this).parent().find("img").first()[0];
                  im.style.opacity = "1";
                  im.removeAttribute("data-erased");                  
                }
              }
                            
              box.appendChild(p);
              box.appendChild(btn);
              images.appendChild(box);                                                        
            }
          }
        }

        jQuery("body").localize();

      }

        

      function createUser()
      { 
        var pars = {};

        pars.email = jQuery("#uc-email").val();
        pars.name = jQuery("#uc-name").val();
        pars.password = jQuery("#uc-password").val();
        pars.type = jQuery("#uc-type").val();

        if(!isValidEmailAddress(pars.email))
        {
          jQuery.jGrowl(i18next.t("error.invalid_email"), {theme:'bg-color-red', life: 5000});
          return;
        }

        jQuery.ajax({
          url: _brokerMsUrl + "admin/users",
          type: "POST",
          data: JSON.stringify(pars),
          contentType: "application/json; charset=utf-8",
          success: function(data, textStatus, xhr)
          {
            jQuery.jGrowl("Success", {theme:'bg-color-green', life: 5000});
          },
          error: function(xhr, status)
          {
            var errMsg = "Internal Server Error";

            if(xhr.responseJSON.error_message)
              errMsg = xhr.responseJSON.error_message;
            else if(xhr.responseJSON.message)
              errMsg = xhr.responseJSON.message;

            jQuery.jGrowl(errMsg, {theme:'bg-color-red', life: 5000});
          },
          beforeSend: function(xhr, settings)
          {
            xhr.setRequestHeader('Authorization','Bearer ' + sessionStorage.token);
          }
        });
      }

      function enableUser(id)
      {
        jQuery.ajax({
          url: _brokerMsUrl + "admin/users/" + id + "/actions/enable",
          type: "POST",
          contentType: "application/json; charset=utf-8",
          success: function(data, textStatus, xhr)
          {
            // success
          },
          beforeSend: function(xhr, settings)
          {
            xhr.setRequestHeader('Authorization','Bearer ' + sessionStorage.token);
          }

        });
      }

      function disableUser(id)
      {
        jQuery.ajax({
          url: _brokerMsUrl + "admin/users/" + id + "/actions/disable",
          type: "POST",
          contentType: "application/json; charset=utf-8",
          success: function(data, textStatus, xhr)
          {
            // success
          },
          beforeSend: function(xhr, settings)
          {
            xhr.setRequestHeader('Authorization','Bearer ' + sessionStorage.token);
          }

        });
      }

      function filterResults(page)
      {
        var p = 1;

        if(page)
          p = page;

        var email = jQuery("#searchUserEmail").val();
        var type = jQuery("#searchUserType").val();
        var par = {};

        if(email.trim() !== "")
          par.email = email;

        if(type.trim() !== "")
          par.type = type;

        findUsers(p, par);        
      }

      function findUsers(page, pars)
      {       
        jQuery.ajax({
          url: _brokerMsUrl + "admin/users" + "?limit=15&page=" + page,
          type: "GET",
          data: pars,
          contentType: "application/json; charset=utf-8",
          success: function(data, textStatus, xhr)
          {
            // success
            data.pars = pars;

            if(pars)
              data.pars = pars ;
            else              
              data.pars = 'undefined';

            var source = $("#users_table_template").html();
            var theTemplate = Handlebars.compile(source);
            var theCompiledHtml = theTemplate(data);
            jQuery("#usersList").html(theCompiledHtml);
            jQuery('[data-toggle=confirmation]').confirmation({
              rootSelector: '[data-toggle=confirmation]',
              // other options
            });
          },
          beforeSend: function(xhr, settings)
          {
            xhr.setRequestHeader('Authorization','Bearer ' + sessionStorage.token);
          }

        });
      }    
 
      function showUsersPanel()
      {
        jQuery("#productsConainer").hide();
        jQuery("#usersContainer").show();
        jQuery("#admin-sidebar .active").removeClass("active");
        jQuery("#groupItemUsers").addClass("active");
      }

      function showProductsPanel()
      {
        jQuery("#usersContainer").hide();
        jQuery("#productsConainer").show();
        jQuery("#admin-sidebar .active").removeClass("active");
        jQuery("#groupItemProducts").addClass("active");
      }


      function getProducts(sid, page)
      {   
        if(page == undefined)
        {
          page = 1;
        }
        if(sid.trim() === "")
          return;

        jQuery.ajax(
        {
          url: _brokerMsUrl + "admin/products?sid=" + sid + "&limit=15&page=" + page,
          type: "GET",
          contentType: "application/json; charset=utf-8",
          success: function(data, textStatus, xhr)
          {  
            // success

            var source = jQuery("#products_table_template").html();
            var template = Handlebars.compile(source);
            var compiledHtml = template(data);
            jQuery("#productsList").html(compiledHtml);
            showProductsPanel();
            jQuery('[data-toggle=confirmation]').confirmation({
              rootSelector: '[data-toggle=confirmation]',
              // other options
            });
          },     
          error: function(xhr, status)
          {      
            switch(xhr.status)
            {
              case 400: 
                if(xhr.responseJSON.error == "invalid_token")
                {
                  jQuery.jGrowl(i18next.t("error.unauthorized"), {theme:'bg-color-red', life: 5000});
                  redirectToLogin();
                }
                else if(xhr.responseJSON.error == "BadRequest")
                  jQuery.jGrowl(i18next.t("error.missing_user_or_password"), {theme:'bg-color-red', life: 5000});
                else
                  jQuery.jGrowl(xhr.responseJSON.error_message, {theme:'bg-color-red', life: 5000});
                break;
              case 401:
                jQuery.jGrowl(i18next.t("error.unauthorized"), {theme:'bg-color-red', life: 5000});
                redirectToLogin();
                break;
              case 500:
                jQuery.jGrowl(i18next.t("error.internal_server_error"), {theme:'bg-color-red', life: 5000});
                break;        
              default:
                jQuery.jGrowl(xhr.responseJSON.error_message, {theme:'bg-color-red', life: 5000});
            }
            return;    
          },
          beforeSend: function(xhr, settings) 
          { 
            xhr.setRequestHeader('Authorization','Bearer ' + sessionStorage.token); 
          }                    
        });        
      }

    </script> 
  
    <script id="users_table_template" type="text/x-handlebars-template">
      <div class="table-search-v1 margin-bottom-30">
        <div class="table-responsive">
          <table class="table table-bordered table-striped">
            <thead>
              <tr>
                <!-- th data-i18n="admin.uTable-id">Id</th -->                
                <th data-i18n="admin.uTable-type">Type</th>                
                <th data-i18n="admin.uTable-email">Email</th>                
                <th data-i18n="admin.uTable-name">Name</th>                
                <th data-i18n="admin.uTable-edit">Edit</th>                
                <th data-i18n="admin.uTable-enable">Enable</th>                
                <th data-i18n="admin.uTable-disable">Disable</th>                            
                <th data-i18n="admin.uTable-delete">Delete</th>                             
                <th data-i18n="admin.uTable-products">Products</th>                             
              </tr>
            </thead>
            <tbody> 
              {{#each docs}}             
              <tr data-id="{{_id}}">
                <!-- td>
                  {{_id}}
                </td -->            
                <td>
                  {{type}}
                </td>            
                <td>
                  {{email}}
                </td>
                <td>
                  {{name}}
                </td>
                <td>
                  <span style="cursor:pointer" onclick="editUser('{{_id}}', '{{type}}', '{{email}}')">
                    <i class="fa fa-pencil"></i>
                  </span>
                </td>           
                <td>
                  <span style="cursor:pointer" onclick="enableUser('{{_id}}')">
                    <i class="fa fa-thumbs-up"></i>
                  </span>
                </td>           
                <td>
                  <span style="cursor:pointer" onclick="disableUser('{{_id}}')">
                    <i class="fa fa-thumbs-down"></i>
                  </span>
                </td>           
                <td>
                  <span style="cursor:pointer" data-title="Do you want to remove user {{email}} ? This action is irreversible!" 
                                   data-placement="top"
                                   data-on-confirm="deleteUser"
                                   data-toggle="confirmation"
                                   data-id="{{_id}}" 
                                   data-popout="true">
                    <i class="fa fa-remove"></i>
                  </span>
                </td>           
                <td>
                  {{#if_eq type 'supplier'}}
                  <span style="cursor:pointer" onclick="getProducts('{{_id}}')">
                    <i class="fa fa-shopping-bag"></i>
                  </span>
                  {{/if_eq}}
                </td>           
              </tr>
              {{/each}}      
            </tbody>
          </table>
        </div>
      </div>
     <div class="text-center">
       <ul class="pagination" id="user-paginator">
         <li><a href="#" onclick="findUsers({{math page '-' 1}}, {{json pars}})" >«</a></li>
         {{#for 1 (math pages '+' 1) 1}}
         <li {{#if_eq this ../page}} class="active"{{/if_eq}}><a href="#" onclick="findUsers({{this}}, {{json ../pars}})">{{this}}</a></li>
         {{/for}}
         <li><a href="#" onclick="findUsers({{math page '+' 1}}, {{json pars}})">»</a></li>
       </ul>
     </div>
    </script>

    <script id="products_table_template" type="text/x-handlebars-template">
      <div class="table-search-v1 margin-bottom-30">
        <div class="table-responsive">
          <table class="table table-bordered table-striped">
            <thead>
              <tr>
                <th data-i18n="admin.pTable-nameIt">Name (IT)</th>                
                <th data-i18n="admin.pTable-nameEn">Name (EN)</th>                
                <th data-i18n="admin.pTable-descIt">Description (IT)</th>                
                <th data-i18n="admin.pTable-descEn">Description (EN)</th>                
                <th data-i18n="admin.pTable-delete">Delete</th>                
                <th data-i18n="admin.pTable-edit">Edit</th>                
              </tr>
            </thead>
            <tbody> 
              {{#each docs}}             
              <tr data-id="{{_id}}" >
                <td>
                  {{name}}
                </td>            
                <td>
                  {{translation.0.name}}
                </td>            
                <td>
                  {{description}}
                </td>
                <td>
                  {{translation.0.description}}
                </td>
                <td>
                  <span style="cursor:pointer" data-title="Do you want to remove user {{email}} ? This action is irreversible!" 
                                   data-placement="top"
                                   data-on-confirm="deleteProduct"
                                   data-toggle="confirmation"
                                   data-id="{{_id}}" 
                                   data-sid="{{supplierId}}" 
                                   data-page="{{../page}}" 
                                   data-popout="true">
                    <i class="fa fa-remove"></i>
                  </span>
                </td>           
                <td>
                  <span style="cursor:pointer" onclick="editProduct('{{_id}}', '{{name}}', '{{json64 this}}')">
                    <i class="fa fa-pencil"></i>
                  </span>
                </td>           
              </tr>
              {{/each}}      
            </tbody>
          </table>
        </div>
      </div>
     <div class="text-center">
       <ul class="pagination" id="user-paginator">
         <li><a href="#" onclick="getProducts('{{docs.0.supplierId}}', {{math page '-' 1}})" >«</a></li>
         {{#for 1 (math pages '+' 1) 1}}
         <li {{#if_eq this ../page}} class="active"{{/if_eq}}><a href="#" onclick="getProducts('{{../docs.1.supplierId}}', {{this}})" >{{this}}</a></li>
         {{/for}}
         <li><a href="#" onclick="getProducts('{{docs.0.supplierId}}', {{math page '+' 1}})">»</a></li>
       </ul>
     </div>
    </script>
 
  </head>

  <body>
    <div class="wrapper">
     <!--=== Header ===-->
      <div id="header_p"></div>
      <!--=== End Header ===-->
		  <div class="container content">
        <!-- Sidebar -->
        <div id="admin-sidebar" class="sidebar-showhide" >
          <div class=" md-margin-bottom-40 hidden-xs">
            <ul class="list-group sidebar-nav-v1 margin-bottom-40" id="sidebar-nav-1" style="min-width:230px">    
              <li class="list-group-item active" onclick="showUsersPanel()" id="groupItemUsers">
                <a href="#">
                  <i class="fa fa-users"></i>
                  <span data-i18n="admin.users">Users</span>
                </a>
              </li>
              <li class="list-group-item" onclick="showProductsPanel()" id="groupItemProducts">
                <a href="#">
                  <i class="fa fa-shopping-bag"></i>
                  <span data-i18n="admin.products">Products</span>
                </a>
              </li>
            </ul>
          </div>
        </div>
        <!-- Sidebar -->
        <div id="productsConainer" class="col-md-8" style="display:none"> 
          <div class="profile-body margin-bottom-20">
            <div class="tab-v1">
              <ul class="nav nav-justified nav-tabs" id="tabContainerProducts">
                <li class="tab-bar active">
                  <a data-toggle="tab" href="#productsList" data-i18n="admin.productsList" aria-expanded="false">Products List</a>
                </li>
              </ul>
              <div class="tab-content" id="tabBodyContainerProducts">
                <div id="productsList" class="profile-edit tab-pane fade in active">
                  <p> Select a supplier from the user list <p>
                </div>
              </div>
            </div>
          </div>
        </div>   

        <div id="usersContainer" class="col-md-8">   
          <div class="profile-body margin-bottom-20">
            <div class="tab-v1">
              <ul class="nav nav-justified nav-tabs" id="tabContainer">
                <li class="tab-bar active">
                  <a data-toggle="tab" href="#userSearch" data-i18n="admin.usersList" aria-expanded="false">Users List</a>
                </li>
                <li class="tab-bar">
                  <a data-toggle="tab" href="#userCreate" data-i18n="admin.userCreate" aria-expanded="true">New User</a>
                </li>              
              </ul>
              <div class="tab-content" id="tabBodyContainer">

                <div id="userSearch" class="profile-edit tab-pane fade in active">
                  <input class="form-control" placeholder="Email" id="searchUserEmail" type="text">
                  <select class="selectpicker form-control"  id="searchUserType">
                    <option value="">Account type</option>
                    <option value="customer">Customer</option>
                    <option value="supplier">Supplier</option>
                    <option value="admin">Admin</option>
                  </select>

                  <br />
                  <br />

                  <span class="input-group-btn">
                    <button class="btn-u" type="button" id="searchUserEmailButton" 
                      onclick="filterResults()">
                      <i class="fa fa-search"></i>
                      <span data-i18n="admin.searchUser">Cerca</span>              
                    </button>
                  </span>
  
                  <br>
                  <div id="usersList" class="profile-edit tab-pane fade in active"> 
                    <div id="usersList">
                    </div>

                  </div>
                </div>
                <div id="userCreate" class="profile-edit tab-pane fade in">
                  <div class="input-group margin-bottom-20">
                    <span class="input-group-addon rounded-left">
                      <i class="icon-envelope"></i>
                    </span>
                    <input class="form-control rounded-right" data-i18n="[placeholder]admin.email" id="uc-email" placeholder="Email" type="email">
                  </div>               

                  <div class="input-group margin-bottom-20">
                    <span class="input-group-addon rounded-left">
                      <i class="icon-pencil"></i>
                    </span>
                    <input class="form-control rounded-right" data-i18n="[placeholder]admin.name" id="uc-name" placeholder="Name" type="text">
                  </div>               

                  <div class="input-group margin-bottom-20">
                    <span class="input-group-addon rounded-left">
                      <i class="icon-lock"></i>
                    </span>
                    <input class="form-control rounded-right" data-i18n="[placeholder]admin.password" id="uc-password" placeholder="Password" type="password">
                  </div>               

                  <div class="input-group margin-bottom-20">
                    <select class="selectpicker form-control"  id="uc-type">
                      <option value="">Account type</option>
                      <option value="customer">Customer</option>
                      <option value="supplier">Supplier</option>
                      <option value="admin">Admin</option>
                    </select>
                  </div>

                  <div class="input-group margin-bottom-20">
                    <button onclick="createUser()" class="btn-u btn-block rounded" data-i18n="admin.createUser">Create</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div> 




		  </div>

      <!--=== Footer Version 1 ===-->
      <div id="footer_p" ></div>
      <!--=== End Footer Version 1 ===-->
    </div><!--/wrapper-->

    <!-- JS Global Compulsory -->
    <script type="text/javascript" src="assets/plugins/jquery/jquery.min.js"></script>
    <script type="text/javascript" src="assets/plugins/jquery/jquery-migrate.min.js"></script>
    <script type="text/javascript" src="assets/plugins/bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="assets/js/plugins/bootstrap-select.min.js"></script>

    <!-- JS Translation -->  
    <script src="assets/js/plugins/i18next.min.js"></script>
    <script src="assets/js/translations/translation.js"></script>  
    <script src="assets/js/plugins/jquery-i18next.min.js"></script>

    <!-- JS Implementing Plugins -->
    <script type="text/javascript" src="assets/plugins/back-to-top.js"></script>
    <script type="text/javascript" src="assets/plugins/smoothScroll.js"></script>
    <script type="text/javascript" src="assets/plugins/sky-forms-pro/skyforms/js/jquery-ui.min.js"></script>
    <script type="text/javascript" src="assets/plugins/sky-forms-pro/skyforms/js/jquery.validate.min.js"></script>
    <script type="text/javascript" src="assets/plugins/sky-forms-pro/skyforms/js/jquery.maskedinput.min.js"></script>
    <script type="text/javascript" src="assets/plugins/scrollbar/js/jquery.mCustomScrollbar.concat.min.js"></script>
    <!-- JS Customization -->
    <script type="text/javascript" src="assets/js/app.js"></script>
    <script type="text/javascript" src="assets/js/forms/reg.js"></script>
    <script type="text/javascript" src="assets/js/forms/checkout.js"></script>
    <script type="text/javascript" src="assets/js/plugins/datepicker.js"></script>
    <script type="text/javascript" src="assets/js/common_header.js"></script>
    <script type="text/javascript" src="assets/js/footer.js"></script>
    <script type="text/javascript" src="assets/js/profile_template.js"></script>
    <script type="text/javascript" src="assets/js/plugins/handlebars.min.js"></script>
    <script type="text/javascript" src="assets/js/plugins/bootstrap-editable.min.js"></script>
    <script type="text/javascript" src="assets/js/plugins/jquery.jgrowl.min.js"></script>
    <script type="text/javascript" src="assets/js/plugins/bootstrap-confirmation.min.js"></script>

    <script type="text/javascript" src="assets/js/plugins/bootstrap-filestyle.min.js"></script>
    <script type="text/javascript" src="assets/js/plugins/typeahead.bundle.js"></script>
    <script type="text/javascript" src="assets/js/utils.js"></script>
    <script type="text/javascript" src="assets/js/custom.js"></script>
    <script type="text/javascript" src="assets/js/sidebar.js"></script>
    <script type="text/javascript" src="assets/js/admin_profile_template.js"></script>
    <!-- script type="text/javascript" src="assets/js/profile.js"></script -->
    <script type="text/javascript">

      if(sessionStorage.userId == undefined  || sessionStorage.type !== "admin")
      {   
        redirectToLogin();
      }
      jQuery(document).ready(function() {
        App.init();
        findUsers(1);       
      });
    </script>
  </body>
</html>
